import { Box, VStack, HStack, Icon, Text, Badge, Circle, Button, Grid, Spinner, Center } from "@chakra-ui/react"
import { motion } from "framer-motion"
import { useState, useEffect } from "react"
import { HiMail, HiX, HiClock } from "react-icons/hi"
import { toaster } from "@/components/ui/toaster"
import { MessageModal } from "@/components/ui/MessageModal"
import { apiService, type Message } from "@/services/api"

const MotionBox = motion(Box)

export const MessagesList = () => {
  const [messages, setMessages] = useState<Message[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [messageStatusFilter, setMessageStatusFilter] = useState("all")
  const [expandedMessageId, setExpandedMessageId] = useState<number | null>(null)
  const [selectedMessage, setSelectedMessage] = useState<Message | null>(null)

  // Fetch messages on component mount
  useEffect(() => {
    fetchMessages()
  }, [])

  const fetchMessages = async () => {
    try {
      setIsLoading(true)
      const response = await apiService.getMessages()
      setMessages(response.data)
    } catch (error) {
      toaster.create({
        title: "Error",
        description: error instanceof Error ? error.message : "Failed to fetch messages",
        type: "error",
        duration: 3000,
      })
    } finally {
      setIsLoading(false)
    }
  }

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    })
  }

  if (isLoading) {
    return (
      <Center py={20}>
        <Spinner size="xl" color="primary.500" />
      </Center>
    )
  }

  }

  // Note: Status is not returned by API, so we'll treat all messages as "unread" by default
  // You can add status management later if needed
  const filteredMessages = messages.filter(
    msg => messageStatusFilter === "all" || messageStatusFilter === "unread"
  )

  return (
    <>
      <VStack gap={6} align="stretch">
        {/* Header with Refresh Button */}
        <HStack justify="space-between">
          <Text fontSize="lg" fontWeight="700" color="text">
            {messages.length} message{messages.length !== 1 ? 's' : ''} received
          </Text>
          <Button
            variant="outline"
            onClick={fetchMessages}
            size="sm"
          >
            Refresh
          </Button>
        </HStack>

        {/* Status Filter - Simplified since API doesn't return status */}
        <HStack gap={3} flexWrap="wrap">
          <Badge
            px={4}
            py={2}
            borderRadius="full"
            cursor="pointer"
            bg={messageStatusFilter === "all" ? "primary.500" : "neutral.100"}
            color={messageStatusFilter === "all" ? "white" : "neutral.700"}
            fontWeight="600"
            fontSize="sm"
            textTransform="capitalize"
            onClick={() => setMessageStatusFilter("all")}
            _hover={{
              bg: messageStatusFilter === "all" ? "primary.600" : "neutral.200"
            }}
            transition="all 0.2s ease"
          >
            All ({messages.length})
          </Badge>
        </HStack>

        {/* Messages List */}
        {messages.length === 0 ? (
          <Box
            p={12}
            bg="white"
            borderRadius="xl"
            border="1px solid"
            borderColor="neutral.200"
            textAlign="center"
          >
            <Text color="neutral.600">No messages received yet.</Text>
          </Box>
        ) : (
          <VStack gap={4} align="stretch">
            {filteredMessages.map((message) => {
            const isExpanded = expandedMessageId === message.id
            
            return (
                <Box
                  key={message.id}
                  bg="white"
                  borderRadius="xl"
                  border="1px solid"
                  borderColor="blue.200"
                  overflow="hidden"
                  transition="all 0.2s ease"
                >
                  {/* Collapsed View */}
                  <Box
                    p={4}
                    cursor="pointer"
                    onClick={() => setExpandedMessageId(isExpanded ? null : message.id!)}
                    _hover={{ bg: "neutral.50" }}
                    transition="background 0.2s ease"
                  >
                    <HStack justify="space-between" gap={3}>
                      <HStack gap={3} flex={1} minW={0}>
                        <Circle size="40px" bg="primary.100" color="primary.600" fontWeight="600" fontSize="md">
                          {message.name.charAt(0).toUpperCase()}
                        </Circle>
                        <VStack align="start" gap={1} flex={1} minW={0}>
                          <HStack gap={2} flexWrap="wrap">
                            <Text fontSize="md" fontWeight="700" color="neutral.900">
                              {message.name}
                            </Text>
                            <Text fontSize="sm" color="neutral.600">
                              • {message.company}
                            </Text>
                          </HStack>
                          <HStack gap={3} flexWrap="wrap" fontSize="sm" color="neutral.600">
                            <HStack gap={1}>
                              <Icon as={HiMail} fontSize="sm" />
                              <Text truncate>{message.email}</Text>
                            </HStack>
                            {message.phone_number && (
                              <HStack gap={1}>
                                <Text>•</Text>
                                <Text>{message.phone_number}</Text>
                              </HStack>
                            )}
                          </HStack>
                        </VStack>
                      </HStack>
                      <HStack gap={2} flexShrink={0}>
                        <Badge
                          colorScheme="blue"
                          fontSize="xs"
                          px={2}
                          py={1}
                        >
                          New
                        </Badge>
                        <Icon
                          as={HiX}
                          fontSize="lg"
                          color="neutral.500"
                          transform={isExpanded ? "rotate(0deg)" : "rotate(45deg)"}
                          transition="transform 0.2s ease"
                        />
                      </HStack>
                    </HStack>
                  </Box>                {/* Expanded View */}
                {isExpanded && (
                  <MotionBox
                    initial={{ height: 0, opacity: 0 }}
                    animate={{ height: "auto", opacity: 1 }}
                    exit={{ height: 0, opacity: 0 }}
                    transition={{ duration: 0.3 }}
                  >
                    <Box p={6} borderTop="1px solid" borderColor="neutral.100">
                      <Grid templateColumns={{ base: "1fr", lg: "2fr 1fr" }} gap={6}>
                        {/* Left Side - Message Details */}
                        <VStack align="stretch" gap={4}>
                          

                          {/* Full Message */}
                          <Box>
                            <Text fontSize="xs" fontWeight="700" color="neutral.600" mb={2} textTransform="uppercase">
                              Message
                            </Text>
                            <Box
                              p={4}
                              bg="neutral.50"
                              borderRadius="lg"
                              border="1px solid"
                              borderColor="neutral.200"
                            >
                              <Text fontSize="sm" color="neutral.700" lineHeight="1.7">
                                {message.message}
                              </Text>
                            </Box>
                          </Box>
                          {/* Contact Info */}
                          <Box>
                            <Text fontSize="xs" fontWeight="700" color="neutral.600" mb={2} textTransform="uppercase">
                              Contact Information
                            </Text>
                            <Grid templateColumns={{ base: "1fr", md: "repeat(2, 1fr)" }} gap={3}>
                              <HStack gap={2}>
                                <Icon as={HiMail} color="primary.500" fontSize="lg" />
                                <VStack align="start" gap={0}>
                                  <Text fontSize="xs" color="neutral.600">Email</Text>
                                  <Text fontSize="sm" fontWeight="600" color="neutral.900">
                                    {message.email}
                                  </Text>
                                </VStack>
                              </HStack>
                              {message.phone_number && (
                                <HStack gap={2}>
                                  <Icon as={HiClock} color="primary.500" fontSize="lg" />
                                  <VStack align="start" gap={0}>
                                    <Text fontSize="xs" color="neutral.600">Phone</Text>
                                    <Text fontSize="sm" fontWeight="600" color="neutral.900">
                                      {message.phone_number}
                                    </Text>
                                  </VStack>
                                </HStack>
                              )}
                            </Grid>
                          </Box>
                        </VStack>

                        {/* Right Side - Meeting Details & Actions */}
                        <VStack align="stretch" gap={4}>
                          <Box>
                            <Text fontSize="xs" fontWeight="700" color="neutral.600" mb={2} textTransform="uppercase">
                              Meeting Details
                            </Text>
                            <VStack align="stretch" gap={2}>
                              <Box>
                                <Text fontSize="xs" color="neutral.600" mb={1}>Meeting Tool</Text>
                                <Badge colorScheme="purple" fontSize="xs">
                                  {message.meeting_tool.replace("-", " ").toUpperCase()}
                                </Badge>
                              </Box>
                              <Box>
                                <Text fontSize="xs" color="neutral.600" mb={1}>Agenda</Text>
                                <Badge colorScheme="blue" fontSize="xs">
                                  {message.agenda.replace("-", " ").toUpperCase()}
                                </Badge>
                              </Box>
                              <Box>
                                <Text fontSize="xs" color="neutral.600" mb={1}>Requested Time</Text>
                                <Text fontSize="sm" fontWeight="600" color="neutral.900">
                                  {formatDate(message.date_time)}
                                </Text>
                              </Box>
                              {message.created_at && (
                                <Box>
                                  <Text fontSize="xs" color="neutral.600" mb={1}>Submitted</Text>
                                  <Text fontSize="sm" fontWeight="600" color="neutral.900">
                                    {formatDate(message.created_at)}
                                  </Text>
                                </Box>
                              )}
                              {message.website && (
                                <Box>
                                  <Text fontSize="xs" color="neutral.600" mb={1}>Website</Text>
                                  <Button
                                    size="xs"
                                    variant="outline"
                                    colorScheme="blue"
                                    onClick={(e) => {
                                      e.stopPropagation()
                                      window.open(message.website, "_blank")
                                    }}
                                  >
                                    Visit Website
                                  </Button>
                                </Box>
                              )}
                            </VStack>
                          </Box>

                          <VStack align="stretch" gap={2}>
                            <Button
                              size="sm"
                              colorScheme="primary"
                              onClick={(e) => {
                                e.stopPropagation()
                                setSelectedMessage(message)
                              }}
                            >
                              View Full Details
                            </Button>
                            <Button
                              size="sm"
                              variant="outline"
                              colorScheme="green"
                              onClick={(e) => {
                                e.stopPropagation()
                                const subject = `Re: ${message.agenda.replace(/-/g, " ")}`
                                window.location.href = `mailto:${message.email}?subject=${encodeURIComponent(subject)}`
                              }}
                            >
                              Reply via Email
                            </Button>
                          </VStack>
                        </VStack>
                      </Grid>
                    </Box>
                  </MotionBox>
                )}
              </Box>
            )
          })}
          </VStack>
        )}
      </VStack>

      {/* Message Modal */}
      <MessageModal
        isOpen={selectedMessage !== null}
        onClose={() => setSelectedMessage(null)}
        message={selectedMessage}
      />
    </>
  )
}
